var Config=function(){"use strict";var e={};e.debug=!1,window.location.search.indexOf("debug")>-1&&(e.debug=!0),e.appName="Tomatotim",e.audio=!1,e.notifications=!1,e.workInterval=1500,e.breakInterval=300,e.longbreakInterval=1200,e.repeat=4,e.debug&&(e.appName="DEBUG",e.workInterval=7,e.breakInterval=5,e.longbreakInterval=6);var t=function(t){return e[t]},i=function(t,i){e[t]=i};return{get:t,set:i}}(),Services={},Views={};Services.Storage=function(){"use strict";var e=function(e){return JSON.parse(localStorage.getItem(e))},t=function(e,t){localStorage.setItem(e,JSON.stringify(t))},i=function(){localStorage.clear()};return{set:t,get:e,clear:i}}(),Services.BrowserDetection=function(){"use strict";var e=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,t="undefined"!=typeof InstallTrigger,i=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,n=!!window.chrome&&!e,r=!1||!!document.documentMode;return{isOpera:e,isFirefox:t,isSafari:i,isChrome:n,isIE:r}}(),Services.Title=function(){"use strict";var e=function(e,t){var i="";t||(i="■ "),document.title=i+e+" – "+Config.get("appName")},t=function(){document.title=Config.get("appName")};return{setTitle:e,resetTitle:t}}(),Services.Favicon=function(){"use strict";var e=document.getElementById("favicon-ico"),t=function(){if(Services.BrowserDetection.isIE)for(var e=document.querySelectorAll("[data-favicon-explorer]"),t=0;t<e.length;t++)document.head.removeChild(e[t])},i=function(t){if(Services.BrowserDetection.isFirefox||Services.BrowserDetection.isIE)e.rel="shortcut icon",e.href="icons/favicon-"+t+".ico",e.id="favicon-ico";else{e=document.createElement("link");var i=document.getElementById("favicon-png");e.rel="icon",e.setAttribute("type","image/png"),e.href="icons/favicon-16x16-"+t+".png",e.setAttribute("sizes","16x16"),e.id="favicon-png",i&&document.head.removeChild(i),document.head.appendChild(e)}};return{init:t,setFavicon:i}}(),Services.Notification=function(){"use strict";var e=5,t=function(){return window.Notification?"granted"!==Notification.permission?(Notification.requestPermission(),!1):!0:!1},i=function(i,n){if(t()){var r=new Notification(Config.get("appName"),{icon:"img/notification-96x96-"+n+".png",body:i});r.onshow=function(){setTimeout(function(){r.close()},1e3*e)}}};return{requestPermission:t,newNotification:i}}(),Services.Audio=function(){"use strict";var e,t=function(){e=document.createElement("audio"),e.src="audio/ding.mp3"},i=function(){e.play()},n=function(t){1>=t&&t>=0||(t=1),e.volume=t};return{init:t,play:i,setVolume:n}}(),Views.Timer=function(){"use strict";var e=document.getElementById("clock"),t=function(){return e.innerHTML.trim()},i=function(t){e.innerHTML=t};return{getTime:t,setTime:i}}(),Views.Progress=function(){"use strict";var e=document.getElementById("progress"),t=e.getElementsByTagName("i"),i=document.getElementById("description"),n={unfinished:"Unfinished interval",work:"Work interval","break":"Break interval",longbreak:"Long break interval",finished:"Finished interval"},r=function(e,i){t[i].className="icon-tomato color-"+e,t[i].title=n[e]},o=function(){c("");for(var e=0;e<t.length;e++)r("unfinished",e)},a=function(t){var i=document.createElement("i");i.className="icon-tomato color-"+t,i.title=n[t],e.appendChild(i)},s=function(){for(;e.firstChild;)e.removeChild(e.firstChild)},c=function(e){i.innerHTML=e};return{setDescription:c,setImageType:r,resetProgress:o,createImage:a,removeImages:s}}(),Views.Controls=function(){"use strict";var e=!0,t=document.getElementById("start"),i=document.getElementById("reset"),n=document.getElementById("skip"),r=document.getElementById("start-icon"),o=document.getElementById("start-caption"),a=function(){e?(o.innerHTML="pause",r.className="icon-pause-1"):(o.innerHTML="start",r.className="icon-play-1"),e=!e},s=function(){e||a()},c=function(){return t},u=function(){return i},g=function(){return n};return{getStartButton:c,getResetButton:u,getSkipButton:g,resetStartButton:s,toogleStartButtonCaption:a}}(),Views.Sidebar=function(){"use strict";var e=!1,t=document.getElementById("sidebar-button"),i=document.getElementById("sidebar-overlay"),n=function(){return i},r=function(){return t},o=function(){e||(document.body.setAttribute("data-sidebar-open",""),e=!0)},a=function(){e&&(document.body.removeAttribute("data-sidebar-open"),e=!1)},s=function(){e?a():o()},c=function(){return e};return{getSidebarOverlay:n,getSidebarButton:r,isSidebarOpen:c,closeSidebar:a,toogleSidebar:s}}(),Views.Settings=function(){"use strict";var e=document.getElementById("audio"),t=document.getElementById("audio-test"),i=document.getElementById("notifications"),n=document.getElementById("notifications-test"),r=document.getElementById("work-interval"),o=document.getElementById("break-interval"),a=document.getElementById("longbreak-interval"),s=document.getElementById("repeat"),c=document.getElementById("reset-settings"),u=function(){return document.querySelectorAll(".settings input[type=number]")},g=function(){return document.querySelectorAll(".settings [data-increment]")};return{audio:e,audioTest:t,notifications:i,notificationsTest:n,workInterval:r,breakInterval:o,longbreakInterval:a,repeat:s,resetSettings:c,getNumberInputs:u,getPlusMinusButtons:g}}();var Sidebar=function(){"use strict";var e=function(){Views.Sidebar.getSidebarButton().addEventListener("click",Views.Sidebar.toogleSidebar),Views.Sidebar.getSidebarOverlay().addEventListener("click",Views.Sidebar.closeSidebar)};return{init:e}}(),Settings=function(){"use strict";var e=function(){var e=Services.Storage.get("audio");null!==e&&Config.set("audio",e);var t=Services.Storage.get("notifications");null!==t&&Config.set("notifications",t),Config.set("workInterval",Services.Storage.get("workInterval")||Config.get("workInterval")),Config.set("breakInterval",Services.Storage.get("breakInterval")||Config.get("breakInterval")),Config.set("longbreakInterval",Services.Storage.get("longbreakInterval")||Config.get("longbreakInterval")),Config.set("repeat",Services.Storage.get("repeat")||Config.get("repeat")),Views.Settings.audio.checked=Config.get("audio"),Views.Settings.notifications.checked=Config.get("notifications"),Views.Settings.workInterval.value=Config.get("workInterval")/60,Views.Settings.breakInterval.value=Config.get("breakInterval")/60,Views.Settings.longbreakInterval.value=Config.get("longbreakInterval")/60,Views.Settings.repeat.value=Config.get("repeat"),Views.Settings.audio.addEventListener("click",function(){Config.set("audio",this.checked),Services.Storage.set("audio",Config.get("audio"))}),Views.Settings.notifications.addEventListener("click",function(){Config.set("notifications",this.checked),Config.get("notifications")===!0&&Services.Notification.requestPermission(),Services.Storage.set("notifications",Config.get("notifications"))}),Views.Settings.audioTest.addEventListener("click",function(){Services.Audio.play()}),Views.Settings.notificationsTest.addEventListener("click",function(){Services.Notification.newNotification("Web notification test","work")});for(var i=["workInterval","breakInterval","longbreakInterval","repeat"],o=Views.Settings.getNumberInputs(),a=Views.Settings.getPlusMinusButtons(),s=0;s<i.length;s++){o[s].addEventListener("blur",n(o[s],i[s]));for(var c=0;2>c;c++)a[2*s+c].addEventListener("click",r(a[2*s+c],i[s]))}Views.Settings.resetSettings.addEventListener("click",function(){var e=confirm("Are you sure?");e&&(Services.Storage.clear(),location.reload(!1))}),Config.get("notifications")===!0&&Services.Notification.requestPermission()},t=function(e,t,i,n){return e=Math.floor(e),e?1*t>e?e=t:e>1*i&&(e=i):e=n,1*e},i=function(e,i){var n=60;"repeat"===i&&(n=1),e.value=t(e.value,e.min,e.max,Config.get(i)/n),Config.set(i,e.value*n),"repeat"===i?(Views.Progress.removeImages(),Timer.init()):Timer.updateIntervals(),Services.Storage.set(i,Config.get(i))},n=function(e,t){return function(){i(e,t)}},r=function(e,t){return function(){var n=e.getAttribute("data-target");n=document.getElementById(n),n.value=1*n.value+1*e.getAttribute("data-increment"),i(n,t)}};return{init:e}}(),Timer=function(){"use strict";var e,t,i,n=[],r=100,o=function(){a(),e=Services.Storage.get("intervalIndex")||0,t=Services.Storage.get("timerInterval")||Config.get("workInterval"),e>n.length-1&&(e=e%2===0?n.length-2:n.length-1);for(var i=0;i<Config.get("repeat");i++)Views.Progress.createImage("unfinished");for(var r=0;e>=r;r++)g(r,!0);0===e&&t<Config.get("workInterval")&&(Views.Progress.setImageType("work",0),Views.Progress.setDescription("work")),0===e&&t===Config.get("workInterval")?Services.Title.resetTitle():Services.Title.setTitle(s(t)),Views.Controls.getStartButton().addEventListener("click",f),Views.Controls.getSkipButton().addEventListener("click",l),Views.Controls.getResetButton().addEventListener("click",m)},a=function(){n=[];for(var e=0;e<Config.get("repeat");e++)n.push(Config.get("workInterval")),n.push(Config.get("breakInterval"));n.pop(),n.push(Config.get("longbreakInterval"))},s=function(e){var t=function(e){return 10>e&&(e="0"+e),e},i=Math.floor(e/60);return e%=60,t(i)+":"+t(e)},c=function(){t--,0>=t&&u();var e=s(t);Views.Timer.setTime(e),Services.Title.setTitle(e,i),Services.Storage.set("timerInterval",t)},u=function(r){r=r||!1,e++,e>n.length-1&&(e=0,m()),t=n[e],g(e,r),Services.Storage.set("intervalIndex",e),r&&(i&&(d(),v()),Services.Title.setTitle(s(t),i),Services.Storage.set("intervalIndex",e),Services.Storage.set("timerInterval",t))},g=function(e,i){var r=Math.floor(e/2);Views.Timer.setTime(s(t)),e===n.length-1?(Services.Favicon.setFavicon("longbreak"),!i&&Config.get("notifications")&&(Services.Notification.newNotification(Config.get("longbreakInterval")/60+" minute long break","longbreak"),Services.Audio.play()),Views.Progress.setDescription("long break"),Views.Progress.setImageType("longbreak",r)):0===e?(Services.Favicon.setFavicon("work"),i||(Config.get("notifications")&&Services.Notification.newNotification("Done","work"),Config.get("audio")&&Services.Audio.play())):e%2===0?(Services.Favicon.setFavicon("work"),i||(Config.get("notifications")&&Services.Notification.newNotification(Config.get("workInterval")/60+" minute work","work"),Config.get("audio")&&Services.Audio.play()),Views.Progress.setDescription("work"),Views.Progress.setImageType("work",r),Views.Progress.setImageType("finished",r-1)):e%2===1&&(Services.Favicon.setFavicon("break"),i||(Config.get("notifications")&&Services.Notification.newNotification(Config.get("breakInterval")/60+" minute break","break"),Config.get("audio")&&Services.Audio.play()),Views.Progress.setDescription("break"),Views.Progress.setImageType("break",r))},l=function(){u(!0)},f=function(){i?d():v(),Services.Title.setTitle(s(t),i),Views.Controls.toogleStartButtonCaption(),0===e&&(Views.Progress.setImageType("work",0),Views.Progress.setDescription("work"))},v=function(){var e=0,t=new Date;i=setInterval(function(){e+=(new Date).getTime()-t.getTime(),e>=1e3&&(c(),e%=1e3),t=new Date},r)},d=function(){i=clearInterval(i)},m=function(){d(),e=0,t=Config.get("workInterval");var i=s(t);Views.Timer.setTime(i),Views.Controls.resetStartButton(),Services.Title.resetTitle(),Services.Favicon.setFavicon("work"),Services.Storage.set("intervalIndex",e),Services.Storage.set("timerInterval",t),Views.Progress.resetProgress()};return{init:o,updateIntervals:a,startTimer:f,pauseTimer:d,skipInterval:l,resetTimer:m}}(),Hotkeys=function(){"use strict";var e={space:32,enter:13,esc:27,tab:9,r:82,s:83,h:72},t=function(){document.addEventListener("keydown",i)},i=function(t){switch(t=t||window.event,t.keyCode){case e.space:t.preventDefault(),Timer.startTimer();break;case e.esc:Views.Sidebar.closeSidebar();break;case e.r:Timer.resetTimer();break;case e.s:Timer.skipInterval();break;case e.h:Views.Sidebar.toogleSidebar();break;case e.tab:Views.Sidebar.isSidebarOpen()||t.preventDefault();break;case e.enter:t.preventDefault()}};return{init:t}}();!function(){"use strict";Services.Favicon.init(),Services.Audio.init(),Settings.init(),Sidebar.init(),Timer.init(),Hotkeys.init()}();